\documentclass[aspectratio=169]{beamer}
\usepackage[orientation=landscape,size=custom,width=16,height=9,scale=0.5,debug]{beamerposter}
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}
\usepackage{cite,enumerate,float,indentfirst}
\usepackage{graphicx}
\title{HighLoad для начинающих}
\author{Dmitry E. Oboukhov}
\date{31 октября 2014}
\begin{document}

\usebackgroundtemplate{%
    \includegraphics[width=\paperwidth,height=\paperheight]{img/main-page.jpg}%
}

\begin{frame}
    \begin{block}
        {\huge HighLoad}
        \par
        {\huge для начинающих}
    \end{block}
\end{frame}


\usebackgroundtemplate{%
    \includegraphics[width=\paperwidth,height=\paperheight]{img/page.jpg}%
}
\maketitle

\begin{frame}{HighLoad, что это?}
    \begin{itemize}

        \item Конференция?
        
        \pause
        \item Высокая нагрузка?

        \pause
        \item Миф?!
    
    \end{itemize}
\end{frame}

\begin{frame}{Высокая нагрузка что это?}
    \begin{itemize}
        
        \pause
        \item $53.328 * 10^9$  запросов в секунду?
            \pause
            {\small - средний CPU}

        \pause
        \item Более реалистично!

        \pause
        \item 1 запрос в секунду?
            \pause
            - любой веб сервер?...
            \pause
            \par {\small перекодирующий видеоролики? :)}
    \end{itemize}
\end{frame}

\begin{frame}{Высокая нагрузка это:}
    \pause
    \begin{center}
        {\huge Нагрузка, с которой не справляется железо}
    \end{center}
\end{frame}

\begin{frame}{Когда это бывает?}
    \pause
    {\large Достигнуты технические ограничения}
    \begin{itemize}
        \pause
        \item Сеть
            \pause {\small - за рамками данного доклада}
        
        \pause\item Память
        \pause\item CPU
        \pause\item Хранилище данных
    \end{itemize}
\end{frame}

\begin{frame}{Причины}
    \begin{itemize}
        \pause
        \item Недоиспользование железа

        \pause
        \item Трудности масштабирования
    \end{itemize}

\end{frame}

\begin{frame}{Причины}
    \begin{block}
        {\huge Архитектурные проблемы}
    \end{block}
\end{frame}

\begin{frame}{Недоиспользование железа}
    Рассмотрим типичный вебсервер.
    \pause на Perl\pause, Python\pause, Ruby\pause...

    \begin{columns}
        \column{.5\textwidth}
        \begin{block}{Задачи одного цикла}
            \begin{itemize}
                \pause
                \item Чтение запроса из сети.

                \pause
                \item Парсинг запроса http.

                \pause
                \item Валидация запроса, выбор контроллера.

                \pause
                \item Запрос(ы) к хранилищу данных.

                \pause
                \item Формирование ответа (template).

                \pause
                \item Отправка ответа клиенту.
            \end{itemize}
        \end{block}

        \pause
        \column{.5\textwidth}
        \begin{block}{Традиционная реализация}
            \begin{itemize}
                \pause
                \item один процесс на один цикл
                
                \pause
                \item один тред на один цикл
            \end{itemize}

        \end{block}
    \end{columns}
\end{frame}


\begin{frame}{Недоиспользование железа}
    \begin{block}{Начались разговоры о HighLoad?}
        \begin{itemize}
            \pause
            \item Увеличение числа процессов/тредов.
            
            \pause
            \item Увеличение числа серверов.
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Недоиспользование железа}
    \begin{block}{Вернемся к рассматриваемому серверу}
        \begin{itemize}
            \pause\item Проблемы наступили при $\approx$100 запросах в секунду.
            
            \pause\item Увеличили число процессов в работе.
                \pause\par Помогло.

            \pause\item Новые проблемы при $\approx$150 запросов в секунду.
            
            \pause\item Дальнейшее увеличение числа процессов помогает слабо.
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Недоиспользование железа}

    \begin{columns}
        \column{.5\textwidth}
        \begin{block}{Что делать?}
            \begin{itemize}
                \pause\item Менять архитектуру?
                    \pause\par - Мы над этим 3 года работали!

                \pause\item Добавлять второй сервер?
                    \pause\par - Это тоже не просто! (бизнеслогика)
            \end{itemize}
        \end{block}

        \column{.5\textwidth}
        \begin{block}{Спокойно!}
            \begin{itemize}
                \pause\item Провести анализ архитектуры.
                \pause\item Провести измерения.
                \pause\item Найти слабые места.
            \end{itemize}
        \end{block}
    \end{columns}
\end{frame}

\begin{frame}{Недоиспользование железа}
    \begin{block}{Измерения}
        \begin{tabular}{ c c }

            \pause Чтение запроса из сети. & 15К RPS  \\
            \pause Парсинг запроса, валидация, выбор контроллера. & 150К RPS/CPU  \\
            \pause Запросы к хранилищу. & 60К RPS \\
            \pause Формирование ответа (Соединение данных с template) & 100К RPS/CPU \\
            \pause Отправка ответа клиенту. & 15К RPS \\

        \end{tabular}
    \end{block}
\end{frame}
    

\begin{frame}{Недоиспользование железа}
    \begin{block}{Итого}
        {\huge
            $\frac{1}{\frac{1}{15 \ 10^3} + \frac{1}{150 \ 10^3} + \frac{1}{60 \ 10^3}+\frac{1}{100 \ 10^3}+\frac{1}{15 \ 10^3}} = 6000 RPS$
        }
    \end{block}

    \pause
    \begin{block}{Но, позвольте!}
        \begin{itemize}
            \pause\item У нас проблемы на 150 RPS!
            \pause\item Тут что-то не так!
        \end{itemize}
    \end{block}
\end{frame}


\begin{frame}{Недоиспользование железа}
    \begin{block}{Начинаем разбираться}
        \begin{itemize}
            \pause\item Хранилище выходит на свои RPS при достаточно большом
                числе соединений к нему.
            \pause\item Либо хранилище надо располагать локально.
                \pause\par {\small неприемлемо.}
            \pause\item То же самое и с взаимодействием с клиентом.
        \end{itemize}
    \end{block}

    \pause
    \begin{block}{Что делать?}
        \begin{itemize}
            \pause\item Попробуем еще увеличить число процессов?
            \pause\item Проблемы стали больше!
            \pause\item Почему?!
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Недоиспользование железа}
    \begin{block}{Резюме ситуации, еще раз}
        \begin{itemize}
            \pause\item Имеется 100500 строк кода,
                над которым работали несколько лет.

            \pause\item Этот код AS IS по результатам измерений
                может выдавать гораздо больше RPS чем в реальности.

            \pause\item Проблемы начинаются на уровне RPS на порядок меньших,
                нежели расчетные.
        \end{itemize}
    \end{block}
\end{frame}


\begin{frame}{Недоиспользование железа}
    \begin{block}{Еще раз рассмотрим цикл обработки}
        \begin{itemize}
            \pause\item Ожидание запроса (данных) от пользователя.
            \pause\item Парсинг запроса, валидация.
            \pause\item Формирование запроса (запросов) в БД.
            \pause\item Ожидание ответа (ответов) из БД.
            \pause\item Соединение данных из БД с шаблоном.
            \pause\item Ожидание отправки данных клиенту.
        \end{itemize}
        
        \begin{itemize}
            \pause\item Следующий клиент!
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Недоиспользование железа}
    \begin{block}{Измеряем}
        \begin{tabular}{ c c }
            \pause Ожидание запроса (данных) от пользователя. & 70 мкс \\
            \pause Парсинг запроса, валидация.  & 6 мкс \\
            \pause Формирование запроса (запросов) в БД. & 1 мкс \\
            \pause Ожидание ответа (ответов) из БД. & 16 мкс \\
            \pause Соединение данных из БД с шаблоном. & 10 мкс\\
            \pause Ожидание отправки данных клиенту. & 70 мкс \\
        \end{tabular}
    \end{block}
\end{frame}

\begin{frame}{Недоиспользование железа}
    \begin{block}{Итого}
        \begin{itemize}
            \item Код выполнялся: $6 + 1 + 10 = \pause17$ мкс
            \pause\item Чего-либо ожидали: $70 + 16 + 70 = \pause156$ мкс
            \pause\item {\large Код выполняется только 10\% времени!}
            \pause\item И при этом тормозит!
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}[fragile]{Недоиспользование железа}
\begin{verbatim}
#include <unistd.h>

int main(int argc, char **argv) {
        int i;
        for (;;) {
                usleep(70);     usleep(7);
                usleep(16);     usleep(10);
                usleep(70); 
        }       
}
\end{verbatim}
\end{frame}

\begin{frame}{Недоиспользование железа}
    \begin{block}{Итого}
        \begin{itemize}
            \pause\item Код, делающий только sleep в цикле неплохо грузит CPU
                \pause\par - по моим измерениям - где-то 15\% загрузки на CPU
            \pause\item Запустив десяток таких ``воркеров'', получаем
                примерно такую же нагрузку как на проблемном сервере.
            \pause\item Понятно что пример синтетический
                (есть вопросы к реализации usleep).
        \end{itemize}
    \end{block}

    \pause
    \begin{block}{Вернемся к нашему серверу}
        \begin{itemize}
            \pause\item Каждая отдельная часть имеет хорошую производительность
                \pause\par достаточную для развития
                            проекта еще на несколько лет вперед.
            \pause\item Большую часть времени (90\%) наш код проводит
                        в ожидании.

            \pause\item Что делать?
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Недоиспользование железа}
    \begin{block}
        {\huge Просто реорганизовать код}
    \end{block}
\end{frame}


\begin{frame}{Событийно-ориентированное программирование}

    \begin{quote}
    Компьютер — это конечный автомат.
        Треды для тех людей, которые не умеют
        программировать конечные автоматы.
    \end{quote}
    \begin{center}
        \begin{uncoverenv}
        Алан Кокс
        \end{uncoverenv}
    \end{center}

\end{frame}

\begin{frame}{Событийно-ориентированное программирование}
    \begin{block}
        {\huge Избавимся от тредов!}
        \pause\par - {\small и процессов.}
    \end{block}
\end{frame}

\begin{frame}{Событийно-ориентированное программирование}
    \begin{block}{Машина событий}
        \begin{itemize}

            \pause\item Вся работа делается в обработчике события.
                \pause\par - в общем случае - callback.

            \pause\item Когда программе нечего делать (например
                она ждет события), то управление возвращается
                машине событий.
                    \pause\par в общем случае - return из callback.

            \pause\item Обработчик события может генерировать другие события и
                устанавливать другие обработчики.
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Событийно-ориентированное программирование}
    \begin{block}{Перестроим наш сервер}
        \begin{itemize}
            \pause\item Ожидание запроса от пользователя.
                \pause\par - заменится обработчиком события
                    "пришел запрос от пользователя"

            \pause\item Парсинг запроса, валидация.
                \pause\par - не изменится

            \pause\item Формирование запроса (запросов) в БД.
                \pause\par - не изменится

            \pause\item Ожидание ответа (ответов) из БД.
                \pause\par - заменится обработчиком события
                        "пришел ответ из БД"

            \pause\item Соединение данных из БД с шаблоном.
                \pause\par - не изменится

            \pause\item Ожидание отправки данных клиенту.
                \pause\par - заменится обработчиком события
                        "данные пользователю отправлены"
        \end{itemize}
    \end{block}
\end{frame}


\begin{frame}{Событийно-ориентированное программирование}
    \begin{block}{Итого}
        \begin{itemize}
            \pause\item Производительность одного сервера выросла в ~10 раз
            \pause\item Одного CPU/коннекта к БД достаточно для еще нескольких
                лет роста нагрузки.

            \pause\item Но слишком много переделок!
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Событийно-ориентированное программирование}
    \begin{block}{Что затронуто изменениями}
        \begin{itemize}
            \pause\item Интерфейс с вебсервером (получение параметров запроса итп)
                \pause\par - некритично.
                    В крайнем случае обходится написанием "врапперов".
                    В большинстве случаев вообще незаметно.
            \pause\item Интерфейс с БД.
                \pause\par - критично. 
                    Много кода бизнеслогики поехало в callbacks. Сложную логику
                    практически невозможно реализовать.
                    Требуется переписывание ~90\% проекта.
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Событийно-ориентированное программирование}
    \begin{block}{Планировщик}
        Поскольку планировщик OS - очень тяжелый, необходим планировщик userspace.
        \begin{itemize}
            \pause\item Невытесняющая многозадачность
            \pause\item Простое порождение ``процессов''
            \pause\item Простое управление
                \pause\par Три основных метода
                \begin{itemize}
                    \pause\item Создать процесс (create, async)
                    \pause\item Передать управление планировщику (yield, cede)
                    \pause\item Разбудить выбранный процесс (wakeup, ready)
                \end{itemize}
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Событийно-ориентированное программирование}
    \begin{block}{Интегрируем с машиной событий}
        Структура кода теперь выглядит так:
        \begin{itemize}
            \pause\item Регистрация события в машине событий
            \pause\item Передача управления планировщику
            \pause\item Событие будит текущий процесс (файбер)
            \pause\item Программа продолжает работу с данными от события
        \end{itemize}
    \end{block}
    \pause
    \begin{block}{Итого}
        Вернулись к (почти) традиционному виду программы.
    \end{block}
\end{frame}

\begin{frame}{Событийно-ориентированное программирование} 
    \begin{block}{Вернемся к нашему серверу}
        \begin{itemize}
            \pause\item Добавляем машину событий
            \pause\item Добавляем библиотеку fibers
            \pause\item Переписываем интерфейс с вебсервером
                \pause\par - некритично, решается враппером.
            \pause\item Переписываем интерфейс с БД
                \pause\par - относительно трудоемко, но решается враппером.
            \pause\item Переписываем другие сетевые обращения (если есть)
                \pause\par - врапперы

            \pause\item Итого: переписываем около 5\% кода.
        \end{itemize}
    \end{block}
\end{frame}

\begin{frame}{Библиотеки и языки}
    \begin{itemize}
        \pause\item Perl
            \pause\par Coro + AnyEvent
        \pause\item Python
            \pause\par fibers + twisted
        \pause\item PHP5
            \pause\par появился оператор yield, fiber
    \end{itemize}
\end{frame}

\begin{frame}{Что дальше?}
    \begin{itemize}
        \pause\item Используем fiber'ы/event-машины
            в том языке к которому привыкли
        \pause\item Рассматриваем существующие варианты
            \begin{itemize}
                \item\pause Node.JS
                    \pause\par - отказались от парадигмы fibers
                \item\pause Tarantool...
            \end{itemize}
    \end{itemize}
\end{frame}


\begin{frame}{Tarantool}
    \begin{itemize}
        \pause\item Полноценный app-сервер
        \pause\item БД на борту
            \pause\par - in-memory
            \pause\par - disk
        \pause\item Сокеты, диск, http-сервер, очереди
    \end{itemize}
\end{frame}

\begin{frame}{Недостатки}
    \begin{itemize}
        \pause\item Для больших проектов одного CPU все-таки маловато
        \pause\item Реализации fiber'ов для традиционных
            ЯП плохо масштабируются по CPU/хостам.
    \end{itemize}
\end{frame}

\begin{frame}{Перспектива}
    \begin{itemize}
        \pause\item Erlang
            \pause\par - хорошее масштабирование по CPU и хостам
            \pause\par - очень качественное решение
            \pause\par - высокий порог вхождения
        \pause\item Go
            \pause\par - более низкий порог вхождения
    \end{itemize}
\end{frame}

\usebackgroundtemplate{%
    \includegraphics[width=\paperwidth,height=\paperheight]{img/main-page.jpg}%
}

\begin{frame}
\end{frame}
\end {document}
